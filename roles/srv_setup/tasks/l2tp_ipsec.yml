---
# tasks file for srv_setup
- name: Password file check
  ansible.builtin.stat:
    path: "{{ role_path + '/files/vpn_creds/' + ansible_hostname + '.pwd' }}"
  register: password_file_check
  ignore_errors: true

- name: Save the generated idempotent password to a local file
  ansible.builtin.lineinfile:
    path: "{{ role_path + '/files/vpn_creds/' + ansible_hostname + '.pwd' }}"
    line: "{{ lookup('password', '/dev/null' + ansible_hostname + '.pwd', length=15, seed=inventory_hostname) }}"
    create: yes
    mode: 400
  delegate_to: localhost
  when: password_file_check.stat.exists is defined and password_file_check.stat.exists == False

- name: Hostname file check
  ansible.builtin.stat:
    path: "{{ role_path + 'files/vpn_ip/' + ansible_hostname }}"
  register: hostname_file_check
  ignore_errors: true

- name: Save hostname to a local file
  ansible.builtin.lineinfile:
    path: "{{ role_path + '/files/vpn_ip/' + ansible_hostname }}"
    line: "{{ ansible_hostname }}"
    create: yes
    mode: 400
  delegate_to: localhost
  when: hostname_file_check.stat.exists is defined and hostname_file_check.stat.exists == False

- name: "Start add_vpn_client local script"
  shell: "{{ role_path + '/files/scripts/add_vpn_client.sh ' + role_path + '/files/vpn_ip ' + role_path + '/files/vpn_creds' }}"
  ignore_errors: true
  delegate_to: localhost

- name: Set IPsec conf
  ansible.builtin.template:
    src: ipsec.conf.j2
    dest: /etc/ipsec.conf
    owner: root
    group: root
    mode: '0644'

- name: Set IPsec secrets
  ansible.builtin.template:
    src: ipsec.secrets.j2
    dest: /etc/ipsec.secrets
    owner: root
    group: root
    mode: '0600'

- name: Set xl2tpd conf
  ansible.builtin.template:
    src: xl2tpd.conf.j2
    dest: /etc/xl2tpd/xl2tpd.conf
    owner: root
    group: root
    mode: '0644'

- name: Set xl2tpd options
  ansible.builtin.template:
    src: options.l2tpd.j2
    dest: /etc/ppp/options.{{ conn_name }}.l2tpd
    owner: root
    group: root
    mode: '0600'
  notify: Start VPN

- name: Set auto add routes
  ansible.builtin.template:
    src: vpn.routes.j2
    dest: /etc/ppp/ip-up.d/{{ conn_name }}.routes
    owner: root
    group: root
    mode: '0755'
  notify: Start VPN